<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to testdat â€¢ testdat</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to testdat">
<meta property="og:description" content="testdat">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">testdat</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.2.0.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/testdat.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/socialresearchcentre/testdat/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="testdat_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to testdat</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/socialresearchcentre/testdat/blob/master/vignettes/testdat.Rmd"><code>vignettes/testdat.Rmd</code></a></small>
      <div class="hidden name"><code>testdat.Rmd</code></div>

    </div>

    
    
<p>testdat is a package designed to ease data validation, particularly for complex data processing, inspired by software unit testing. testdat extends the strong and flexible unit testing framework already provided by testthat with a family of functions and reporting tools focused on checking data frames.</p>
<p>Features include:</p>
<ul>
<li><p>A fully fledged test framework so you can spend more time specifying tests and less time running them</p></li>
<li><p>A set of common methods for simply specifying data validation rules</p></li>
<li><p>Repeatability of data tests (avoid unintentionally breaking your data set!)</p></li>
<li><p>Data-focused reporting of test results</p></li>
</ul>
<div id="getting-started" class="section level1">
<h1 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h1>
<p>As an extension of testthat, testdat uses the same basic testing framework. Before using testdat (and reading this documentation), make sure youâ€™re familiar with the introduction to testthat in <a href="https://r-pkgs.org/tests.html">R packages</a>.</p>
<p>The main addition provided by testdat is a set of expectations designed for testing data frames and an accompanying mechanism to globally specify a data set for testing.</p>
</div>
<div id="data-expectations" class="section level1">
<h1 class="hasAnchor">
<a href="#data-expectations" class="anchor"></a>Data expectations</h1>
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>In general, our approach to data testing is variable-centric - the majority of expectations perform a check on one or more variables in a given data frame.</p>
<p>The standard form of a data expectation is:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>expect_<span class="op">*</span>(<span class="kw">var</span>(s), ..., <span class="dt">flt =</span> <span class="ot">TRUE</span>, <span class="dt">data =</span> <span class="kw">get_testdata</span>())</span></code></pre></div>
<p>testdat uses dplyr at its core, and thus supports tidy evaluation.</p>
<div id="variables" class="section level3">
<h3 class="hasAnchor">
<a href="#variables" class="anchor"></a>Variables</h3>
<p>Most operations act on one or more variables. There are two variants of the variable argument:</p>
<ul>
<li>
<code>vars</code> requires a set of columns specified as <a href="https://dplyr.tidyverse.org/reference/dplyr_tidy_select.html">tidy selections</a>.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">test_that</span><span class="op">(</span><span class="st">"multi-variable identifier is unique"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/uniqueness-expectations.html">expect_unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span>, <span class="va">hour</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">storms</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; â”€â”€ Failure (&lt;text&gt;:2:3): multi-variable identifier is unique â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="co">#&gt; `storms` has 32 duplicate records on variable `name, year, month, day, hour`.</span>
<span class="co">#&gt; Filter: None</span>
<span class="co">#&gt; Error: Test failed</span></code></pre></div>
<ul>
<li>
<code>var</code> requires an unquoted variable name. This only applies to a small number of expectations.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">test_that</span><span class="op">(</span><span class="st">"hour values are valid"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/conditional-expectations.html">expect_base</a></span><span class="op">(</span><span class="va">ts_diameter</span>, <span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">2004</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; â”€â”€ Error (&lt;text&gt;:2:3): hour values are valid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="co">#&gt; Error: A test data frame has not been specified. Use `set_testdata()` to set the data frame.</span>
<span class="co">#&gt; Backtrace:</span>
<span class="co">#&gt;  1. testdat::expect_base(ts_diameter, year &gt;= 2004)</span>
<span class="co">#&gt;  4. testdat::get_testdata()</span>
<span class="co">#&gt; Error: Test failed</span></code></pre></div>
</div>
<div id="filter" class="section level3">
<h3 class="hasAnchor">
<a href="#filter" class="anchor"></a>Filter</h3>
<p>The <code>flt</code> argument takes a logical predicate defined in terms of the variables in <code>data</code> using <a href="https://dplyr.tidyverse.org/reference/dplyr_data_masking.html">data masking</a>. Only rows where the condition evaluates to <code>TRUE</code> are included in the test.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">test_that</span><span class="op">(</span><span class="st">"iris range checks"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/value-expectations.html">expect_range</a></span><span class="op">(</span><span class="va">Petal.Width</span>, <span class="fl">0</span>, <span class="fl">1</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; â”€â”€ Failure (&lt;text&gt;:2:3): iris range checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="co">#&gt; `iris` has 93 records failing range check on variable `Petal.Width`.</span>
<span class="co">#&gt; Filter: None</span>
<span class="co">#&gt; Arguments: `min = 0, max = 1`</span>
<span class="co">#&gt; Error: Test failed</span>

<span class="fu">test_that</span><span class="op">(</span><span class="st">"iris range checks filtered"</span>, <span class="op">{</span>
  <span class="co"># Test passes for setosa rows</span>
  <span class="fu"><a href="../reference/value-expectations.html">expect_range</a></span><span class="op">(</span><span class="va">Petal.Width</span>, <span class="fl">0</span>, <span class="fl">1</span>, flt <span class="op">=</span> <span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span>
  <span class="co"># Failures will provide the filter</span>
  <span class="fu"><a href="../reference/value-expectations.html">expect_range</a></span><span class="op">(</span><span class="va">Petal.Width</span>, <span class="fl">0</span>, <span class="fl">0.5</span>, flt <span class="op">=</span> <span class="va">Species</span> <span class="op">==</span> <span class="st">"setosa"</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; â”€â”€ Failure (&lt;text&gt;:9:3): iris range checks filtered â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="co">#&gt; `iris` has 1 records failing range check on variable `Petal.Width`.</span>
<span class="co">#&gt; Filter: `Species == "setosa"`</span>
<span class="co">#&gt; Arguments: `min = 0, max = 0.5`</span>
<span class="co">#&gt; Error: Test failed</span></code></pre></div>
</div>
<div id="data" class="section level3">
<h3 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h3>
<p>The <code>data</code> argument takes a data frame to test. To avoid redundant code the data argument defaults to a global test data set retrieved using <code><a href="../reference/global-data.html">get_testdata()</a></code>. This can be used in two ways:</p>
<ul>
<li>Setting the global test data using <code><a href="../reference/global-data.html">set_testdata()</a></code>.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/global-data.html">set_testdata</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="../reference/global-data.html">get_testdata</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">iris</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span>

<span class="fu">test_that</span><span class="op">(</span><span class="st">"Versicolor has sepal length greater than 5 - will fail"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/conditional-expectations.html">expect_cond</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">%in%</span> <span class="st">"versicolor"</span>, <span class="va">Sepal.Length</span> <span class="op">&gt;=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; â”€â”€ Failure (&lt;text&gt;:5:3): Versicolor has sepal length greater than 5 - will fail â”€â”€</span>
<span class="co">#&gt; get_testdata() failed consistency check. 1 cases have `Species %in% "versicolor"` but not `Sepal.Length &gt;= 5`.</span>
<span class="co">#&gt; Error: Test failed</span></code></pre></div>
<ul>
<li>Using the <code><a href="../reference/global-data.html">with_testdata()</a></code> wrapper to temporarily set the global test data for a block of code.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/global-data.html">set_testdata</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="../reference/global-data.html">get_testdata</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span>

<span class="fu"><a href="../reference/global-data.html">with_testdata</a></span><span class="op">(</span><span class="va">iris</span>, <span class="op">{</span>
  <span class="fu">test_that</span><span class="op">(</span><span class="st">"Versicolor has sepal length greater than 5 - will fail"</span>, <span class="op">{</span>
    <span class="fu"><a href="../reference/conditional-expectations.html">expect_cond</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">%in%</span> <span class="st">"versicolor"</span>, <span class="va">Sepal.Length</span> <span class="op">&gt;=</span> <span class="fl">5</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; â”€â”€ Failure (&lt;text&gt;:6:5): Versicolor has sepal length greater than 5 - will fail â”€â”€</span>
<span class="co">#&gt; get_testdata() failed consistency check. 1 cases have `Species %in% "versicolor"` but not `Sepal.Length &gt;= 5`.</span>
<span class="co">#&gt; Error: Test failed</span>

<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="fu"><a href="../reference/global-data.html">get_testdata</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">mtcars</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>Both approaches are equivalent to:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">test_that</span><span class="op">(</span><span class="st">"Versicolor has sepal length greater than 5 - will fail"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/conditional-expectations.html">expect_cond</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">%in%</span> <span class="st">"versicolor"</span>, <span class="va">Sepal.Length</span> <span class="op">&gt;=</span> <span class="fl">5</span>, data <span class="op">=</span> <span class="va">iris</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; â”€â”€ Failure (&lt;text&gt;:2:3): Versicolor has sepal length greater than 5 - will fail â”€â”€</span>
<span class="co">#&gt; `iris` failed consistency check. 1 cases have `Species %in% "versicolor"` but not `Sepal.Length &gt;= 5`.</span>
<span class="co">#&gt; Error: Test failed</span></code></pre></div>
<p>By default, <code><a href="../reference/global-data.html">set_testdata()</a></code> stores a quosure with a reference to the provided data frame rather than the data itself, so changes made to the data frame will be reflected in the test results.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tmp_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="../reference/global-data.html">set_testdata</a></span><span class="op">(</span><span class="va">tmp_data</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/global-data.html">get_testdata</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 Ã— 2</span>
<span class="co">#&gt;       x     y</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1     1</span>
<span class="co">#&gt; 2     0    NA</span>
<span class="fu"><a href="../reference/conditional-expectations.html">expect_base</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">x</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">tmp_data</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/global-data.html">get_testdata</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 Ã— 2</span>
<span class="co">#&gt;       x     y</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1     1     1</span>
<span class="co">#&gt; 2     0     1</span>
<span class="fu"><a href="../reference/conditional-expectations.html">expect_base</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">x</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; Error: get_testdata() has a base mismatch in variable `y`.</span>
<span class="co">#&gt; 0 cases have `x == 1` but `y` is missing.</span>
<span class="co">#&gt; 1 cases do not have `x == 1` but `y` is non missing.</span></code></pre></div>
</div>
<div id="section" class="section level3">
<h3 class="hasAnchor">
<a href="#section" class="anchor"></a><code>...</code>
</h3>
<p>Additional arguments are specific to the expectation. See the help page for the expectation function for details.</p>
</div>
</div>
<div id="categories" class="section level2">
<h2 class="hasAnchor">
<a href="#categories" class="anchor"></a>Categories</h2>
<p>Data expectations fall into a few main classes.</p>
<dl>
<dt>Value</dt>
<dd>
<p><code><a href="../reference/date-expectations.html">?`date-expectations`</a></code></p>
</dd>
<dd>
<code><a href="../reference/label-expectations.html">?`label-expectations`</a></code>
</dd>
<dd>
<code><a href="../reference/pattern-expectations.html">?`pattern-expectations`</a></code>
</dd>
<dd>
<code><a href="../reference/proportion-expectations.html">?`proportion-expectations`</a></code>
</dd>
<dd>
<code><a href="../reference/text-expectations.html">?`text-expectations`</a></code>
</dd>
<dd>
<p><code><a href="../reference/value-expectations.html">?`value-expectations`</a></code></p>
<p>Value expectations test variable values for valid data. Tests include explicit value checks, pattern checks and others.</p>
</dd>
<dt>Relationships</dt>
<dd>
<p><code><a href="../reference/exclusivity-expectations.html">?`exclusivity-expectations`</a></code></p>
</dd>
<dd>
<p><code><a href="../reference/uniqueness-expectations.html">?`uniqueness-expectations`</a></code></p>
<p>Relationship expectations test for relationships among variables. Tests include uniqueness and exclusivity checks.</p>
</dd>
<dt>Conditional</dt>
<dd>
<p><code><a href="../reference/conditional-expectations.html">?`conditional-expectations`</a></code></p>
<p>Conditional expectations check for the co-existence of multiple conditions.</p>
</dd>
<dt>Data frame comparison</dt>
<dd>
<p><code><a href="../reference/datacomp-expectations.html">?`datacomp-expectations`</a></code></p>
<p>Data frame comparison expectations test for consistency between data frames, for example ensuring similar frequencies between similar variables in different data frames.</p>
</dd>
<dt>Generic</dt>
<dd>
<p><code><a href="../reference/generic-expectations.html">?`generic-expectations`</a></code></p>
<p>Generic expectations allow for testing of a data frame using an arbitrary function. The function provided should take a single vector as its first argument and return a logical vector showing whether each element has passed or failed. Additional arguments to the checking function can be passed as a list using the <code>args</code> argument.</p>
<p>testdat includes a set of useful checking functions. See <code>?`chk-generic`</code> for details. Several of the checking functions have a corresponding expectation. These are listed in <code>?`chk-expect`</code>.</p>
</dd>
</dl>
</div>
</div>
<div id="using-tests" class="section level1">
<h1 class="hasAnchor">
<a href="#using-tests" class="anchor"></a>Using tests</h1>
<div id="testing-inside-a-script" class="section level2">
<h2 class="hasAnchor">
<a href="#testing-inside-a-script" class="anchor"></a>Testing inside a script</h2>
<p>The easiest way to use data testing is directly inside an R script. Expecations and test blocks throw an error if they fail, so it is very clear to the user that something needs to be checked, and the script will fail when sourced.</p>
<p>The example below shows how to adapt a script from exploratory â€œprint and checkâ€ to a testing approach, using a simple data processing exercise.</p>
<div id="print-and-check" class="section level3">
<h3 class="hasAnchor">
<a href="#print-and-check" class="anchor"></a>Print and check</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span><span class="op">~</span><span class="va">id</span>, <span class="op">~</span><span class="va">pcode</span>, <span class="op">~</span><span class="va">state</span>, <span class="op">~</span><span class="va">nsw_only</span>,
             <span class="fl">1</span>,   <span class="fl">2000</span>,   <span class="st">"NSW"</span>,  <span class="fl">1</span>,
             <span class="fl">2</span>,   <span class="fl">3123</span>,   <span class="st">"VIC"</span>,  <span class="cn">NA</span>,
             <span class="fl">3</span>,   <span class="fl">2123</span>,   <span class="st">"NSW"</span>,  <span class="fl">3</span>,
             <span class="fl">4</span>,   <span class="fl">12345</span>,  <span class="st">"VIC"</span>,  <span class="fl">3</span><span class="op">)</span>

<span class="co"># check id is unique</span>
<span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 0 Ã— 4</span>
<span class="co">#&gt; # â€¦ with 4 variables: id &lt;dbl&gt;, pcode &lt;dbl&gt;, state &lt;chr&gt;, nsw_only &lt;dbl&gt;</span>

<span class="co"># check values</span>
<span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">pcode</span> <span class="op">%in%</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">3999</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1 Ã— 4</span>
<span class="co">#&gt;      id pcode state nsw_only</span>
<span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;</span>
<span class="co">#&gt; 1     4 12345 VIC          3</span>
<span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 Ã— 2</span>
<span class="co">#&gt;   state     n</span>
<span class="co">#&gt;   &lt;chr&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1 NSW       2</span>
<span class="co">#&gt; 2 VIC       2</span>
<span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">nsw_only</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 Ã— 2</span>
<span class="co">#&gt;   nsw_only     n</span>
<span class="co">#&gt;      &lt;dbl&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1        1     1</span>
<span class="co">#&gt; 2        3     2</span>
<span class="co">#&gt; 3       NA     1</span>

<span class="co"># check base for nsw_only variable</span>
<span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">!=</span> <span class="st">"NSW"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">nsw_only</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 Ã— 2</span>
<span class="co">#&gt;   nsw_only     n</span>
<span class="co">#&gt;      &lt;dbl&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1        3     1</span>
<span class="co">#&gt; 2       NA     1</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>market <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">pcode</span> <span class="op">%in%</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2999</span> <span class="op">~</span> <span class="fl">1</span>,
                                     <span class="va">pcode</span> <span class="op">%in%</span> <span class="fl">3000</span><span class="op">:</span><span class="fl">3999</span> <span class="op">~</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">market</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 3 Ã— 2</span>
<span class="co">#&gt;   market     n</span>
<span class="co">#&gt;    &lt;dbl&gt; &lt;int&gt;</span>
<span class="co">#&gt; 1      1     2</span>
<span class="co">#&gt; 2      2     1</span>
<span class="co">#&gt; 3     NA     1</span></code></pre></div>
</div>
<div id="testdat" class="section level3">
<h3 class="hasAnchor">
<a href="#testdat" class="anchor"></a>testdat</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://socialresearchcentre.github.io/testdat/">testdat</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span><span class="op">~</span><span class="va">id</span>, <span class="op">~</span><span class="va">pcode</span>, <span class="op">~</span><span class="va">state</span>, <span class="op">~</span><span class="va">nsw_only</span>,
             <span class="fl">1</span>,   <span class="fl">2000</span>,   <span class="st">"NSW"</span>,  <span class="fl">1</span>,
             <span class="fl">2</span>,   <span class="fl">3123</span>,   <span class="st">"VIC"</span>,  <span class="cn">NA</span>,
             <span class="fl">3</span>,   <span class="fl">2123</span>,   <span class="st">"NSW"</span>,  <span class="fl">3</span>,
             <span class="fl">4</span>,   <span class="fl">12345</span>,  <span class="st">"VIC"</span>,  <span class="fl">3</span><span class="op">)</span>

<span class="fu"><a href="../reference/global-data.html">with_testdata</a></span><span class="op">(</span><span class="va">x</span>, <span class="op">{</span>
  <span class="fu">test_that</span><span class="op">(</span><span class="st">"id is unique"</span>, <span class="op">{</span>
    <span class="fu"><a href="../reference/uniqueness-expectations.html">expect_unique</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
  
  <span class="fu">test_that</span><span class="op">(</span><span class="st">"variable values are correct"</span>, <span class="op">{</span>
    <span class="fu"><a href="../reference/value-expectations.html">expect_values</a></span><span class="op">(</span><span class="va">pcode</span>, <span class="fl">2000</span><span class="op">:</span><span class="fl">2999</span>, <span class="fl">3000</span><span class="op">:</span><span class="fl">3999</span><span class="op">)</span>
    <span class="fu"><a href="../reference/value-expectations.html">expect_values</a></span><span class="op">(</span><span class="va">state</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NSW"</span>, <span class="st">"VIC"</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="../reference/value-expectations.html">expect_values</a></span><span class="op">(</span><span class="va">nsw_only</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="co"># by default expect_values allows NAs</span>
  <span class="op">}</span><span class="op">)</span>
  
  <span class="fu">test_that</span><span class="op">(</span><span class="st">"filters applied correctly"</span>, <span class="op">{</span>
    <span class="fu"><a href="../reference/conditional-expectations.html">expect_base</a></span><span class="op">(</span><span class="va">nsw_only</span>, <span class="va">state</span> <span class="op">==</span> <span class="st">"NSW"</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Test passed ğŸ¥³</span>
<span class="co">#&gt; â”€â”€ Failure (&lt;text&gt;:16:5): variable values are correct â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="co">#&gt; get_testdata() has 1 records failing value check on variable `pcode`.</span>
<span class="co">#&gt; Filter: None</span>
<span class="co">#&gt; Arguments: `&lt;int: 2000L, 2001L, 2002L, 2003L, 2004L, ...&gt;, &lt;int: 3000L, 3001L, 3002L,`</span>
<span class="co">#&gt; get_testdata() has 1 records failing value check on variable `pcode`.</span>
<span class="co">#&gt; Filter: None</span>
<span class="co">#&gt; Arguments: `  3003L, 3004L, ...&gt;, miss = &lt;chr: NA, ""&gt;`</span>
<span class="co">#&gt; Error: Test failed</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>market <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">pcode</span> <span class="op">%in%</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2999</span> <span class="op">~</span> <span class="fl">1</span>,
                                     <span class="va">pcode</span> <span class="op">%in%</span> <span class="fl">3000</span><span class="op">:</span><span class="fl">3999</span> <span class="op">~</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="../reference/global-data.html">with_testdata</a></span><span class="op">(</span><span class="va">x</span>, <span class="op">{</span>
  <span class="fu">test_that</span><span class="op">(</span><span class="st">"market derived correctly"</span>, <span class="op">{</span>
    <span class="fu"><a href="../reference/value-expectations.html">expect_values</a></span><span class="op">(</span><span class="va">market</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, miss <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="co"># miss = NULL excludes NAs from valid values</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; â”€â”€ Failure (&lt;text&gt;:31:5): market derived correctly â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
<span class="co">#&gt; get_testdata() has 1 records failing value check on variable `market`.</span>
<span class="co">#&gt; Filter: None</span>
<span class="co">#&gt; Arguments: `&lt;int: 1L, 2L&gt;, miss = NULL`</span>
<span class="co">#&gt; Error: Test failed</span></code></pre></div>
<p>Note that:</p>
<ul>
<li><p>The global test data can be set with <code><a href="../reference/global-data.html">set_testdata()</a></code> or <code><a href="../reference/global-data.html">with_testdata()</a></code>.</p></li>
<li><p>The <code>test_that()</code> wrapper is not strictly necessary, but it provides more informative error messaging and logically groups a set of expectations.</p></li>
<li><p>The <code><a href="../reference/global-data.html">with_testdata()</a></code> block will run all <code>test_that()</code> blocks, even if some fail. If expectations are not surrounded by a <code>test_that()</code> wrapper, the block will exit after the first failed test.</p></li>
</ul>
</div>
</div>
<div id="using-a-test-suite" class="section level2">
<h2 class="hasAnchor">
<a href="#using-a-test-suite" class="anchor"></a>Using a test suite</h2>
<p>Setting up a proper project test suite can be useful for automatically validating final processed data sets.</p>
<p>Setting up proper file based testing infrastructure is out of the scope of this vignette. See <a href="https://r-pkgs.org/tests.html">R packages</a> for a brief introduction to testing infrastructure.</p>
<p>In testthat, related tests are grouped into files. When using testdat, each file should have a test data set specified with a call to <code><a href="../reference/global-data.html">set_testdata()</a></code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/global-data.html">set_testdata</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>

<span class="fu">test_that</span><span class="op">(</span><span class="st">"Variable format checks"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/pattern-expectations.html">expect_regex</a></span><span class="op">(</span><span class="va">Species</span>, <span class="st">"^[a-z]+$"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Test passed ğŸ¥³</span>

<span class="fu">test_that</span><span class="op">(</span><span class="st">"Versicolor has sepal length greater than 5 - will fail"</span>, <span class="op">{</span>
  <span class="fu"><a href="../reference/conditional-expectations.html">expect_cond</a></span><span class="op">(</span><span class="va">Species</span> <span class="op">%in%</span> <span class="st">"versicolor"</span>, <span class="va">Sepal.Length</span> <span class="op">&gt;=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; â”€â”€ Failure (&lt;text&gt;:8:3): Versicolor has sepal length greater than 5 - will fail â”€â”€</span>
<span class="co">#&gt; get_testdata() failed consistency check. 1 cases have `Species %in% "versicolor"` but not `Sepal.Length &gt;= 5`.</span>
<span class="co">#&gt; Error: Test failed</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Danny Smith, Kinto Behr.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
